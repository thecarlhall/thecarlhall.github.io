<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage data-theme=light><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>JavaMail in OSGi - Carlibrated!
</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes"><meta name=MobileOptimized content="width"><meta name=HandheldFriendly content="true"><meta name=applicable-device content="pc,mobile"><meta name=color-scheme content="light dark"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=mobile-web-app-capable content="yes"><meta name=generator content="Hugo 0.140.0"><link rel=canonical href=https://thecarlhall.github.io/post/javamail-in-osgi/><meta name=author content="Carl Hall"><meta name=description content="UnsupportedDataTypeException Sun decided ages ago that JavaMail and the Java Activation Framework should be released as separate artifacts and no one really cared. If you need JavaMail, you knew to also include JAF as Sun&rsquo;s JavaMail page also told what version of JAF to use. Using this same approach, I created and deployed separate bundles for javax.activation and javax.mail. As soon as I tried to send the first test email, I found trouble. The most basic of email content types, text/plain, could not be sent.
"><meta name=keywords content="java,javamail,osgi"><meta property="og:url" content="https://thecarlhall.github.io/post/javamail-in-osgi/"><meta property="og:site_name" content="Carlibrated!"><meta property="og:title" content="JavaMail in OSGi"><meta property="og:description" content="UnsupportedDataTypeException Sun decided ages ago that JavaMail and the Java Activation Framework should be released as separate artifacts and no one really cared. If you need JavaMail, you knew to also include JAF as Sun’s JavaMail page also told what version of JAF to use. Using this same approach, I created and deployed separate bundles for javax.activation and javax.mail. As soon as I tried to send the first test email, I found trouble. The most basic of email content types, text/plain, could not be sent."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2009-10-27T00:00:00+00:00"><meta property="article:modified_time" content="2009-10-27T00:00:00+00:00"><meta property="article:tag" content="Java"><meta property="article:tag" content="Javamail"><meta property="article:tag" content="Osgi"><meta itemprop=name content="JavaMail in OSGi"><meta itemprop=description content="UnsupportedDataTypeException Sun decided ages ago that JavaMail and the Java Activation Framework should be released as separate artifacts and no one really cared. If you need JavaMail, you knew to also include JAF as Sun’s JavaMail page also told what version of JAF to use. Using this same approach, I created and deployed separate bundles for javax.activation and javax.mail. As soon as I tried to send the first test email, I found trouble. The most basic of email content types, text/plain, could not be sent."><meta itemprop=datePublished content="2009-10-27T00:00:00+00:00"><meta itemprop=dateModified content="2009-10-27T00:00:00+00:00"><meta itemprop=wordCount content="442"><meta itemprop=keywords content="Java,Javamail,Osgi"><meta name=twitter:card content="summary"><meta name=twitter:title content="JavaMail in OSGi"><meta name=twitter:description content="UnsupportedDataTypeException Sun decided ages ago that JavaMail and the Java Activation Framework should be released as separate artifacts and no one really cared. If you need JavaMail, you knew to also include JAF as Sun’s JavaMail page also told what version of JAF to use. Using this same approach, I created and deployed separate bundles for javax.activation and javax.mail. As soon as I tried to send the first test email, I found trouble. The most basic of email content types, text/plain, could not be sent."><link rel=icon href=/favicon.ico><link rel=stylesheet href=/css/style.min.de488e0d4b09a0b9f6412192239661fda9bb9ea66e49d8f210bf0786a4e36acb.css integrity="sha256-3kiODUsJoLn2QSGSI5Zh/am7nqZuSdjyEL8HhqTjass=" media=screen crossorigin=anonymous><link rel=stylesheet href=/css/custom.css><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--><div class=carl-header><img src=/images/soon-cat.jpg alt="Header Image"></div><script>(function(){var e=localStorage.getItem("theme")||"light";document.documentElement.setAttribute("data-theme",e)})()</script></head><body><div id=back-to-top></div><header class=site-header><div class=desktop-header><div class=desktop-header-logo><a href=/ class=logo>Carlibrated</a></div><nav class=desktop-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=https://thecarlhall.github.io/>Home</a></li><li class=menu-item><a class=menu-item-link href=https://thecarlhall.github.io/post/>Posts</a></li><li class=menu-item><a class=menu-item-link href=https://thecarlhall.github.io/categories/>Categories</a></li><li class=menu-item><a class=menu-item-link href=https://thecarlhall.github.io/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=https://thecarlhall.github.io/about/>About</a></li><li class=menu-item><a class="theme-toggle menu-item-link" href=javascript:void(0);><svg aria-hidden="true" class="lucide lucide-sun hi-svg-inline theme-icon-light" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg><svg aria-hidden="true" class="lucide lucide-moon hi-svg-inline theme-icon-dark" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M12 3a6 6 0 009 9 9 9 0 11-9-9z"/></svg></a></li><li class=menu-item><a class=menu-item-link href=https://thecarlhall.github.io/index.xml rel="noopener alternate" type=application/rss+xml title=rss target=_blank><svg aria-hidden="true" class="lucide lucide-rss hi-svg-inline icon--rss" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></li></ul></nav></div><div class=mobile-header><div id=mobile-navbar class=mobile-navbar><div id=mobile-navbar-icon class=mobile-navbar-icon><svg aria-hidden="true" class="lucide lucide-menu hi-svg-inline icon--menu" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg></div><div class=mobile-navbar-logo><a href=/ class=logo>Carlibrated</a></div></div><div id=mobile-menu-close-modal class=mobile-menu-close-modal></div><nav id=mobile-menu class=mobile-menu><ul class=mobile-menu-list><li class=mobile-menu-item><a class=menu-item-link href=https://thecarlhall.github.io/>Home</a></li><li class=mobile-menu-item><a class=menu-item-link href=https://thecarlhall.github.io/post/>Posts</a></li><li class=mobile-menu-item><a class=menu-item-link href=https://thecarlhall.github.io/categories/>Categories</a></li><li class=mobile-menu-item><a class=menu-item-link href=https://thecarlhall.github.io/tags/>Tags</a></li><li class=mobile-menu-item><a class=menu-item-link href=https://thecarlhall.github.io/about/>About</a></li><li class=mobile-menu-item><a class="theme-toggle menu-item-link" href=javascript:void(0);><svg aria-hidden="true" class="lucide lucide-sun hi-svg-inline theme-icon-light" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg><svg aria-hidden="true" class="lucide lucide-moon hi-svg-inline theme-icon-dark" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M12 3a6 6 0 009 9 9 9 0 11-9-9z"/></svg></a></li><li class=mobile-menu-item><a class=menu-item-link href=https://thecarlhall.github.io/index.xml rel="noopener alternate" type=application/rss+xml title=rss target=_blank><svg aria-hidden="true" class="lucide lucide-rss hi-svg-inline icon--rss" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></li></ul></nav></div></header><main id=main class="main pico container"><div class=content-wrapper><aside class=sidebar></aside><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>JavaMail in OSGi</h1><div class=post-meta-list><div class="post-meta-item post-meta-author"><svg aria-hidden="true" class="lucide lucide-user-round-pen hi-svg-inline" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M2 21a8 8 0 0110.821-7.487"/><path d="M21.378 16.626a1 1 0 00-3.004-3.004l-4.01 4.012a2 2 0 00-.506.854l-.837 2.87a.5.5.0 00.62.62l2.87-.837a2 2 0 00.854-.506z"/><circle cx="10" cy="8" r="5"/></svg>
<a href=/about><span class=post-meta-author-name>Carl Hall</span></a></div><div class="post-meta-item post-meta-time"><svg aria-hidden="true" class="lucide lucide-calendar-days hi-svg-inline" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>
<time datetime=2009-10-27>2009-10-27</time></div><div class=post-meta__right><div class="post-meta-item post-meta-category"><a href=https://thecarlhall.github.io/categories/development/>development</a></div></div></div></header><div class=post-content><h2 id=unsupporteddatatypeexception>UnsupportedDataTypeException</h2><p>Sun decided ages ago that JavaMail and the Java Activation Framework should be released as separate artifacts and no one really cared. If you need JavaMail, you knew to also include JAF as Sun&rsquo;s JavaMail page also told what version of JAF to use. Using this same approach, I created and deployed separate bundles for javax.activation and javax.mail. As soon as I tried to send the first test email, I found trouble. The most basic of email content types, text/plain, could not be sent.</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><pre tabindex=0><code>javax.activation.UnsupportedDataTypeException: no object DCH for MIME type text/plain at javax.activation.ObjectDataContentHandler.writeTo(DataHandler.java:885)</code></pre></div><p>This sent me digging into the source of javax.activation and javax.mail to find the fix. The problem here is that when the Java Activation Framework starts up, it loads META-INF/mailcap.defaults then looks for META-INF/mailcap files in other libraries in the same classloader. These mailcap files define handlers for specific types of content (eg. text/plain). Since JAF and JavaMail were in separate bundles and thusly classloaders, the mailcap file in JavaMail couldn&rsquo;t be seen by JAF. The fix I went with was to merge the 2 bundles into 1. I didn&rsquo;t want to do this at first but after I saw that JAF uses an internal class named MailcapCommandMap, I decided that if the Sun developers felt it fine to give JAF explicit knowledge of JavaMail, it was fine with me to marry them to the same bundle. If you&rsquo;re using Equinox, you can use buddy classloaders without merging the bundles together, but I have a couple of problems with buddy classloaders.</p><ol><li>They are not part of the OSGi spec and break your ability to move to another container.</li><li>They create a situation where a parent bundle has to have knowledge of children or &ldquo;buddy&rdquo; bundles. This goes against the basic whiteboard approach of OSGi.</li></ol><h2 id=unable-to-resolve-sunsecurityutil>Unable to resolve sun.security.util</h2><p>Another fun bit to note is that starting with JavaMail 1.4.1, there is use of the sun.security.util package. If your OSGi container exports sun.* classes, you won&rsquo;t notice this. If your OSGi container doesn&rsquo;t export this or you run on a non-Sun JVM, this seems like a blocking issue. Fear not! After digging through the JavaMail code I find a comment in the SocketFetcher class that reads:</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e> * First, try to use sun.security.util.HostnameChecker,
</span></span></span><span style=display:flex><span><span style=color:#75715e> * which exists in Sun&#39;s JDK starting with 1.4.1.
</span></span></span><span style=display:flex><span><span style=color:#75715e> * We use reflection to access it in case it&#39;s not available
</span></span></span><span style=display:flex><span><span style=color:#75715e> * in the JDK we&#39;re running on.
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span></span></span></code></pre></div></div><p>This let me know that I can set this package to optional in my import list and all would be well. In other words, your bundle manifest should have something like this:</p><p><code>Import-Package: sun.security.util;resolution:=optional</code></p></div><div class=post-copyright><p class=copyright-item><span class=item-title>Author</span>
<span class=item-content>Carl Hall</span></p><p class=copyright-item><span class=item-title>LastMod</span>
<span class=item-content>2009-10-27</span></p><p class=copyright-item><span class=item-title>License</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span></p></div><footer class=post-footer><div class=post-tags><a href=https://thecarlhall.github.io/tags/java/>java</a>
<a href=https://thecarlhall.github.io/tags/javamail/>javamail</a>
<a href=https://thecarlhall.github.io/tags/osgi/>osgi</a></div><nav class=post-nav><a class=prev href=/post/clicking-things/><i class=iconfont><svg aria-hidden="true" class="lucide lucide-chevron-left hi-svg-inline" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="m15 18-6-6 6-6"/></svg>
</i><span class="prev-text nav-default">Clicking Things</span>
<span class="prev-text nav-mobile">Prev</span>
</a><a class=next href=/post/google-gears-for-64-bit-linux/><span class="next-text nav-default">Google Gears for 64-bit Linux</span>
<span class="prev-text nav-mobile">Next</span>
<i class=iconfont><svg aria-hidden="true" class="lucide lucide-chevron-right hi-svg-inline" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="m9 18 6-6-6-6"/></svg></i></a></nav></footer></article></div><nav class=toc id=toc><div class=toc-title>Table of Contents</div><div class="toc-content custom-scrollbar"><nav id=TableOfContents><ul><li><a href=#unsupporteddatatypeexception>UnsupportedDataTypeException</a></li><li><a href=#unable-to-resolve-sunsecurityutil>Unable to resolve sun.security.util</a></li></ul></nav></div></nav></div></main><footer id=footer class=site-footer><div class=social-icon-links><a href=https://thecarlhall.github.io/index.xml rel="noopener alternate" type=application/rss+xml class=social-icon-link title=rss target=_blank><svg aria-hidden="true" class="lucide lucide-rss hi-svg-inline" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span><span class=division>|</span>
<span class=theme-info>Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a>
</span><span class=copyright-year>&copy;
2024
<span class=heart><i class=iconfont><svg aria-hidden="true" class="lucide lucide-heart hi-svg-inline" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5.0 0016.5 3c-1.76.0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5.0 002 8.5c0 2.3 1.5 4.05 3 5.5l7 7z"/></svg>
</i></span><span class=author>Carl Hall</span></span></div></footer><script type=text/javascript src=/js/main.22922b44c2472763db448ad18224b6dafba94e9de0a8d08b7542197bffebf023.js integrity="sha256-IpIrRMJHJ2PbRIrRgiS22vupTp3gqNCLdUIZe//r8CM=" crossorigin=anonymous></script><script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script><script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script></body></html>