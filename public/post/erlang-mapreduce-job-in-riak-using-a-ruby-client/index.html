<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage data-theme=light><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Erlang Map/Reduce Job in Riak using a Ruby Client - Carlibrated!
</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes"><meta name=MobileOptimized content="width"><meta name=HandheldFriendly content="true"><meta name=applicable-device content="pc,mobile"><meta name=color-scheme content="light dark"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=mobile-web-app-capable content="yes"><meta name=generator content="Hugo 0.140.0"><link rel=canonical href=https://thecarlhall.github.io/post/erlang-mapreduce-job-in-riak-using-a-ruby-client/><meta name=author content="Carl Hall"><meta name=description content="Note: I am horrible at Erlang, but have figured out enough to construct a Map/Reduce job. Hopefully these notes serve as more than a warning.
It&rsquo;s rarely possible to know every way you will want to access your data. Riak has secondary indices (2i) but if you don&rsquo;t have one that represents what you want to query, it can be time consuming to populate one of these when you have a lot of documents. Ad-hoc queries are rarely where a database will shine, but when you have a one-off job, sometimes Map/Reduce is the only option you have.
"><meta name=keywords content="erlang,map-reduce,riak,ruby"><meta property="og:url" content="https://thecarlhall.github.io/post/erlang-mapreduce-job-in-riak-using-a-ruby-client/"><meta property="og:site_name" content="Carlibrated!"><meta property="og:title" content="Erlang Map/Reduce Job in Riak using a Ruby Client"><meta property="og:description" content="Note: I am horrible at Erlang, but have figured out enough to construct a Map/Reduce job. Hopefully these notes serve as more than a warning.
It’s rarely possible to know every way you will want to access your data. Riak has secondary indices (2i) but if you don’t have one that represents what you want to query, it can be time consuming to populate one of these when you have a lot of documents. Ad-hoc queries are rarely where a database will shine, but when you have a one-off job, sometimes Map/Reduce is the only option you have."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2013-02-11T00:00:00+00:00"><meta property="article:modified_time" content="2013-02-11T00:00:00+00:00"><meta property="article:tag" content="Erlang"><meta property="article:tag" content="Map-Reduce"><meta property="article:tag" content="Riak"><meta property="article:tag" content="Ruby"><meta itemprop=name content="Erlang Map/Reduce Job in Riak using a Ruby Client"><meta itemprop=description content="Note: I am horrible at Erlang, but have figured out enough to construct a Map/Reduce job. Hopefully these notes serve as more than a warning.
It’s rarely possible to know every way you will want to access your data. Riak has secondary indices (2i) but if you don’t have one that represents what you want to query, it can be time consuming to populate one of these when you have a lot of documents. Ad-hoc queries are rarely where a database will shine, but when you have a one-off job, sometimes Map/Reduce is the only option you have."><meta itemprop=datePublished content="2013-02-11T00:00:00+00:00"><meta itemprop=dateModified content="2013-02-11T00:00:00+00:00"><meta itemprop=wordCount content="773"><meta itemprop=keywords content="Erlang,Map-Reduce,Riak,Ruby"><meta name=twitter:card content="summary"><meta name=twitter:title content="Erlang Map/Reduce Job in Riak using a Ruby Client"><meta name=twitter:description content="Note: I am horrible at Erlang, but have figured out enough to construct a Map/Reduce job. Hopefully these notes serve as more than a warning.
It’s rarely possible to know every way you will want to access your data. Riak has secondary indices (2i) but if you don’t have one that represents what you want to query, it can be time consuming to populate one of these when you have a lot of documents. Ad-hoc queries are rarely where a database will shine, but when you have a one-off job, sometimes Map/Reduce is the only option you have."><link rel=icon href=/favicon.ico><link rel=stylesheet href=/css/style.min.de488e0d4b09a0b9f6412192239661fda9bb9ea66e49d8f210bf0786a4e36acb.css integrity="sha256-3kiODUsJoLn2QSGSI5Zh/am7nqZuSdjyEL8HhqTjass=" media=screen crossorigin=anonymous><link rel=stylesheet href=/css/custom.css><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--><div class=carl-header><img src=/images/soon-cat.jpg alt="Header Image"></div><script>(function(){var e=localStorage.getItem("theme")||"light";document.documentElement.setAttribute("data-theme",e)})()</script></head><body><div id=back-to-top></div><header class=site-header><div class=desktop-header><div class=desktop-header-logo><a href=/ class=logo>Carlibrated</a></div><nav class=desktop-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=https://thecarlhall.github.io/>Home</a></li><li class=menu-item><a class=menu-item-link href=https://thecarlhall.github.io/post/>Posts</a></li><li class=menu-item><a class=menu-item-link href=https://thecarlhall.github.io/categories/>Categories</a></li><li class=menu-item><a class=menu-item-link href=https://thecarlhall.github.io/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=https://thecarlhall.github.io/about/>About</a></li><li class=menu-item><a class="theme-toggle menu-item-link" href=javascript:void(0);><svg aria-hidden="true" class="lucide lucide-sun hi-svg-inline theme-icon-light" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg><svg aria-hidden="true" class="lucide lucide-moon hi-svg-inline theme-icon-dark" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M12 3a6 6 0 009 9 9 9 0 11-9-9z"/></svg></a></li><li class=menu-item><a class=menu-item-link href=https://thecarlhall.github.io/index.xml rel="noopener alternate" type=application/rss+xml title=rss target=_blank><svg aria-hidden="true" class="lucide lucide-rss hi-svg-inline icon--rss" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></li></ul></nav></div><div class=mobile-header><div id=mobile-navbar class=mobile-navbar><div id=mobile-navbar-icon class=mobile-navbar-icon><svg aria-hidden="true" class="lucide lucide-menu hi-svg-inline icon--menu" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg></div><div class=mobile-navbar-logo><a href=/ class=logo>Carlibrated</a></div></div><div id=mobile-menu-close-modal class=mobile-menu-close-modal></div><nav id=mobile-menu class=mobile-menu><ul class=mobile-menu-list><li class=mobile-menu-item><a class=menu-item-link href=https://thecarlhall.github.io/>Home</a></li><li class=mobile-menu-item><a class=menu-item-link href=https://thecarlhall.github.io/post/>Posts</a></li><li class=mobile-menu-item><a class=menu-item-link href=https://thecarlhall.github.io/categories/>Categories</a></li><li class=mobile-menu-item><a class=menu-item-link href=https://thecarlhall.github.io/tags/>Tags</a></li><li class=mobile-menu-item><a class=menu-item-link href=https://thecarlhall.github.io/about/>About</a></li><li class=mobile-menu-item><a class="theme-toggle menu-item-link" href=javascript:void(0);><svg aria-hidden="true" class="lucide lucide-sun hi-svg-inline theme-icon-light" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg><svg aria-hidden="true" class="lucide lucide-moon hi-svg-inline theme-icon-dark" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M12 3a6 6 0 009 9 9 9 0 11-9-9z"/></svg></a></li><li class=mobile-menu-item><a class=menu-item-link href=https://thecarlhall.github.io/index.xml rel="noopener alternate" type=application/rss+xml title=rss target=_blank><svg aria-hidden="true" class="lucide lucide-rss hi-svg-inline icon--rss" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></li></ul></nav></div></header><main id=main class="main pico container"><div class=content-wrapper><aside class=sidebar></aside><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>Erlang Map/Reduce Job in Riak using a Ruby Client</h1><div class=post-meta-list><div class="post-meta-item post-meta-author"><svg aria-hidden="true" class="lucide lucide-user-round-pen hi-svg-inline" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M2 21a8 8 0 0110.821-7.487"/><path d="M21.378 16.626a1 1 0 00-3.004-3.004l-4.01 4.012a2 2 0 00-.506.854l-.837 2.87a.5.5.0 00.62.62l2.87-.837a2 2 0 00.854-.506z"/><circle cx="10" cy="8" r="5"/></svg>
<a href=/about><span class=post-meta-author-name>Carl Hall</span></a></div><div class="post-meta-item post-meta-time"><svg aria-hidden="true" class="lucide lucide-calendar-days hi-svg-inline" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>
<time datetime=2013-02-11>2013-02-11</time></div><div class=post-meta__right><div class="post-meta-item post-meta-category"><a href=https://thecarlhall.github.io/categories/development/>development</a></div></div></div></header><div class=post-content><p><em>Note: I am horrible at Erlang, but have figured out enough to construct a Map/Reduce job. Hopefully these notes serve as more than a warning.</em></p><p>It&rsquo;s rarely possible to know every way you will want to access your data. Riak has secondary indices (2i) but if you don&rsquo;t have one that represents what you want to query, it can be time consuming to populate one of these when you have a lot of documents. Ad-hoc queries are rarely where a database will shine, but when you have a one-off job, sometimes Map/Reduce is the only option you have.</p><p>In the example code below, I&rsquo;m using the <a href=https://github.com/basho/riak-ruby-client>Riak Ruby Client</a> to talk to a Riak ring. I&rsquo;m getting my client from <a href=https://github.com/basho/ripple>Ripple</a> because it is already setup by the time this method is called. Create a client in whatever way makes sense for your application. Look below the code example for some line-specific notes.</p><script src=https://gist.github.com/thecarlhall/4751334.js></script><h3 id=erlang-notes>Erlang Notes</h3><ul><li><p><strong>lines 17, 38</strong> - Define the language of the <code>map</code> and <code>reduce</code> phases, respectively. Yes, this means you can use a different language in the <code>map</code> phase than you do in the <code>reduce</code> phase (e.g. <code>map: erlang</code>, <code>reduce: javascript</code>).</p></li><li><p><strong>lines 19-35, 40-42</strong> - This is the real meat of the processing puzzle. When defining Erlang functions here, you have to use anonymous functions which start with <code>fun</code>.</p></li><li><p><strong>line 19</strong> - Defining these functions requires some knowledge of what&rsquo;s to be passed in, so let&rsquo;s look at what the arguments are</p><ul><li><p><strong>Obj</strong> - Riak object/document as retrieved from the bucket.</p></li><li><p><strong>_KeyData</strong> - Information about the document&rsquo;s key.</p></li><li><p><strong>_Arg</strong> - Static argument passed by the caller into the <code>map</code> phase.</p></li></ul></li><li><p><strong>lines 20-21</strong> - Turn the Riak document into a structure. We store our data as json so we use <code>mochijson:decode</code> to transform the data.</p></li><li><p><strong>lines 23-28</strong> - Define a function to help with picking the data that matches the supplied argument(s).</p></li><li><p><strong>lines 30-34</strong> - Use the supplied argument to filter the data we want. Return an empty array if the data doesn&rsquo;t match our query.</p></li><li><p><strong>line 40</strong> - Again with the function definitions and arguments.</p><ul><li><p><strong>Values</strong> - Result from the map phase.</p></li><li><p><strong>_Arg</strong> - Static argument passed by the caller into the <code>reduce</code> phase.</p></li></ul></li><li><p><strong>line 41</strong> - Artificially limit the results by a supplied argument.</p></li></ul><h3 id=general-processing-notes>General Processing Notes</h3><ul><li><p><strong>line 49</strong> - Using a list of keys will help performance greatly. See below for suggestions on obtaining a list of keys.</p></li><li><p><strong>line 52</strong> - To help with VM memory, and to imitate so semblance of transactionality, I run things in batches.</p></li><li><p><strong>lines 54-56</strong> - This defines the job iteslf. The <code>map</code> phase or the <code>reduce</code> phase can be ommitted but not both. The <code>keep</code> argument determines whether the documents from this phase are included in the final output. I tend to use <code>keep=true</code> only on the last phase run (i.e. <code>map</code> phase if no <code>reduce</code>; <code>reduce</code> phase otherwise)</p></li><li><p><strong>line 58</strong> - Add each <code>bucket</code>/<code>key</code> pair to the job. The key can be excluded specifying just the bucket but this will cause a full bucket scan. I&rsquo;ve had problems with blowing out the VM memory when not specifying the keys and iterating a large bucket.</p></li></ul><h3 id=obtaining-document-keys>Obtaining Document Keys</h3><p>I get a list of keys independent of my map reduce job to take some of the overhead out of the MR job itself. I&rsquo;ve used a couple of different methods to get a list of keys to process.</p><ol><li><p><strong><strong>Query keys from an index</strong>.</strong> If you have an index you can lean on, it will cut down lots of overhead to query that index for keys to work through.</p></li><li><p><a href=http://docs.basho.com/riak/1.2.1/references/apis/http/HTTP-List-Keys/#Request><strong>Stream key list from the bucket</strong></a>. This can take a while and add significant overhead to the ring, but is useful if you need all keys in the bucket. When streaming keys, the multipart response produces what looks like multiple documents. The pattern, <code>{"keys": [..]}</code>, will show up multiple times and require some massaging before it can be read by a JSON reader.</p></li></ol><p>Given my ignorance of Erlang and Riak, I&rsquo;m sure there are better ways to accomplish these same steps. I&rsquo;ve performed the same work using JavaScript with like results, but JavaScript is handled outside of the Erlang VM and doesn&rsquo;t tend to be as fast as Erlang. For M/R jobs that you will be running more than once, it is suggested to compile the Erlang functions and putting the libraries on the servers in the ring.</p><p>At this point, I&rsquo;m just parroting what I&rsquo;ve heard and can only cause confusion saying more. Hopefully this is more helpful than confusing. Be sure to check #riak on Freenode for some really great people and help.</p></div><div class=post-copyright><p class=copyright-item><span class=item-title>Author</span>
<span class=item-content>Carl Hall</span></p><p class=copyright-item><span class=item-title>LastMod</span>
<span class=item-content>2013-02-11</span></p><p class=copyright-item><span class=item-title>License</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span></p></div><footer class=post-footer><div class=post-tags><a href=https://thecarlhall.github.io/tags/erlang/>erlang</a>
<a href=https://thecarlhall.github.io/tags/map-reduce/>map-reduce</a>
<a href=https://thecarlhall.github.io/tags/riak/>riak</a>
<a href=https://thecarlhall.github.io/tags/ruby/>ruby</a></div><nav class=post-nav><a class=prev href=/post/integration-testing-with-dynamodb-locally/><i class=iconfont><svg aria-hidden="true" class="lucide lucide-chevron-left hi-svg-inline" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="m15 18-6-6 6-6"/></svg>
</i><span class="prev-text nav-default">Integration Testing with DynamoDB Locally</span>
<span class="prev-text nav-mobile">Prev</span>
</a><a class=next href=/post/find-activate-immediately-services-that-lack-an-activate-method/><span class="next-text nav-default">Find activate-immediately services that lack an activate method</span>
<span class="prev-text nav-mobile">Next</span>
<i class=iconfont><svg aria-hidden="true" class="lucide lucide-chevron-right hi-svg-inline" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="m9 18 6-6-6-6"/></svg></i></a></nav></footer></article></div><nav class=toc id=toc><div class=toc-title>Table of Contents</div><div class="toc-content custom-scrollbar"><nav id=TableOfContents><ul><li><ul><li><a href=#erlang-notes>Erlang Notes</a></li><li><a href=#general-processing-notes>General Processing Notes</a></li><li><a href=#obtaining-document-keys>Obtaining Document Keys</a></li></ul></li></ul></nav></div></nav></div></main><footer id=footer class=site-footer><div class=social-icon-links><a href=https://thecarlhall.github.io/index.xml rel="noopener alternate" type=application/rss+xml class=social-icon-link title=rss target=_blank><svg aria-hidden="true" class="lucide lucide-rss hi-svg-inline" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span><span class=division>|</span>
<span class=theme-info>Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a>
</span><span class=copyright-year>&copy;
2024
<span class=heart><i class=iconfont><svg aria-hidden="true" class="lucide lucide-heart hi-svg-inline" fill="none" height="1em" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5.0 0016.5 3c-1.76.0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5.0 002 8.5c0 2.3 1.5 4.05 3 5.5l7 7z"/></svg>
</i></span><span class=author>Carl Hall</span></span></div></footer><script type=text/javascript src=/js/main.22922b44c2472763db448ad18224b6dafba94e9de0a8d08b7542197bffebf023.js integrity="sha256-IpIrRMJHJ2PbRIrRgiS22vupTp3gqNCLdUIZe//r8CM=" crossorigin=anonymous></script><script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script><script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script></body></html>